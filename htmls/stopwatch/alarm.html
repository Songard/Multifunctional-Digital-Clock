<!DOCTYPE html>
<html lang="cn"
    style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>闹钟 Alarm</title>
    <link rel="stylesheet" href="../../css/navbar.css">

    <style>
        .body {
            width: 100%;
            display: flex;
            justify-content: center;
            flex-direction: column;
        }

        .top {
            display: flex;
            justify-content: center;
            position: fixed;
            top: 0;
            width: 100%;
        }

        .dial {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .alarm {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .setAlarm {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: row;
        }
    </style>

</head>

<body class="body" id="bd">

    <div class="top">
        <div class="navbar">
            <div class="navbar_inner">
                <a href="../world_clock/world_clock.html">世界时钟</a>
                <a href="alarm.html">闹钟</a>
                <a href="../stopwatch/stopwatch.html">计时器</a>
                <a href="../timer/timer.html">秒表</a>
            </div>
        </div>
    </div>

    <div class="dial">
        <iframe id="dial" width="400" height="400" frameborder="no" marginwidth="0" marginheight="0"
            src="../main_clock/clock.html">
        </iframe>
    </div>

    <div class="alarm">
        <h2>设置闹钟</h2>
        <div id="setAlarm">
            <input id="alarmHours" type="number" placeholder="时" min="0" max="23">
            <input id="alarmMinutes" type="number" placeholder="分" min="0" max="59">
            <!--<input id="alarmSeconds" type="number" placeholder="秒" min="0" max="59">-->
            <button onclick="setAlarm()">设置闹钟</button>
            <button id="cancelAlarm">取消闹钟</button>
            <audio id="alarm-sound" src="alarm.mp3" preload="auto"></audio>
        </div>
    </div>

    <script>
        var userSetHours = 0;
        var userSetMinutes = 0;
        var userSetSeconds = 0;
        var alarmHour = 0;
        var alarmMinute = 0;
        var alarmSecond = 0;
        var clockInterval; // 定义一个变量来存储定时器的ID

        function setAlarm() {
            alarmHour = document.getElementById('alarmHours').value;
            alarmMinute = document.getElementById('alarmMinutes').value;
            // alarmSecond = document.getElementById('alarmSeconds').value;
            // 验证输入的时间是否有效
            if (alarmHour < 0 || alarmHour >= 24 || alarmMinute < 0 || alarmMinute >= 60 || alarmSecond < 0 || alarmSecond >= 60) {
                alert("输入的时间无效，请输入正确的时间！");
                alarmHour = 0;
                alarmMinute = 0;
                alarmSecond = 0;
                return; // 阻止闹钟设置
            }
            alert("闹钟设置成功！");
            checkAlarm();
        }

        function checkAlarm() {
            clockInterval = setInterval(function () {

                if (userSetHours >= alarmHour && userSetMinutes >= alarmMinute && userSetSeconds >= alarmSecond) {
                    console.log("时间到！");
                    document.getElementById('alarm-sound').play(); // 播放音频
                    alert("时间到！"); // 弹窗提示

                    clearInterval(clockInterval); // 停止检查
                }
            }, 1000);
        }

        document.getElementById('cancelAlarm').addEventListener('click', function () {
            clearInterval(clockInterval); // 停止定时器
            alarmHour = 0; // 可选：重置闹钟时间
            alarmMinute = 0; // 可选：重置闹钟时间
            alarmSecond = 0; // 可选：重置闹钟时间
            alert("闹钟已取消！");
        });

        // 由于使用iframe将表盘与页面分离，
        // 因此获取表盘时间改为使用postMessage进行页面间通信
        // 提取表盘iframe
        var iframe = document.getElementById('dial');
        // 当表盘加载完成后，每隔一小段时间，向表盘页面发送时间请求
        iframe.onload = function () {
            setInterval(function () {
                iframe.contentWindow.postMessage({ type: 'getTime' }, '*');
            }, 500);
        };

        // 设置监听，每当接收到表盘发来的时间,将当前时间设置为用户设置的时间
        // 用于checkAlarm函数中的时间比较
        window.addEventListener('message', function (e) {
            userSetHours = e.data.hours;
            userSetMinutes = e.data.minutes;
            userSetSeconds = e.data.seconds;
            console.log("当前时间：" + userSetHours + ":" + userSetMinutes + ":" + userSetSeconds);
        });

    </script>
</body>

</html>