<!DOCTYPE html>
<html lang="cn" style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
    .body {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    /* 表盘大小 */
    #clock {
        width: 300px;
        height: 300px;
    }
    
    /* 表盘上的刻度数字 */
    .number {
        font-family: Arial, sans-serif;
        font-size: 20px;
        text-anchor: middle;
    }

    /* 数字时间显示 */
    #timeDisplay {
        font-family: Arial, sans-serif;
        font-size: 24px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 300px;
        text-align: center;
    }

    #timeInput {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
    }

    #timeInput input {
        width: 50px;
        text-align: center;
        margin: 0 5px;
    }

    #setTimeButton {
        margin-left: 10px;
    }

    #currentTimeButton {
        margin-top: 10px;
    }

    /* 日期显示 */
    #dateDisplay {
        font-family: Arial, sans-serif;
        font-size: 24px;
        background-color: #f0f0f0;
        border: 1px solid #ddd;
        border-radius: 5px;
        width: 300px;
        text-align: center;
        margin-top: 10px;
    }

    #dateInput {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 10px;
    }

    #dateInput input {
        width: 70px;
        text-align: center;
        margin: 0 5px;
    }

    #setDateButton {
        margin-left: 10px;
    }


    #hour-hand, #minute-hand, #second-hand {
        cursor: pointer;
    }
    </style>
</head>

<body class = "body">
    <!-- 利用SVG画图实现的表盘时钟，需注意中心点统一 -->
    <svg id="clock">
        <!-- 表盘 -->
        <circle cx="150" cy="150" r="140" stroke="black" stroke-width="2" fill="lightblue" />
        <!-- 时针，分针，秒针 -->
        <line x1="150" y1="150" x2="150" y2="70" stroke="black" stroke-width="5" id="hour-hand" />
        <line x1="150" y1="150" x2="150" y2="50" stroke="black" stroke-width="3" id="minute-hand" />
        <line x1="150" y1="150" x2="150" y2="40" stroke="red" stroke-width="1" id="second-hand" />
        <circle cx="150" cy="150" r="4" stroke="black" stroke-width="2" fill="gray" />
        <!-- 表盘上的刻度数字 -->
        <g id="numbers" transform="translate(150,150)">
            <text x="0" y="-107" class="number">12</text>
            <text x="115" y="7" class="number">3</text>
            <text x="0" y="120" class="number">6</text>
            <text x="-115" y="7" class="number">9</text>
        </g>
        <!-- 表盘上的刻度线 -->
        <g id="ticks" transform="translate(150,150)">
            <line x1="0" y1="-120" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(30)" />
            <line x1="0" y1="-120" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(60)" />
            <line x1="0" y1="-125" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(90)" />
            <line x1="0" y1="-120" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(120)" />
            <line x1="0" y1="-120" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(150)" />
            <line x1="0" y1="-125" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(180)" />
            <line x1="0" y1="-120" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(210)" />
            <line x1="0" y1="-120" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(240)" />
            <line x1="0" y1="-125" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(270)" />
            <line x1="0" y1="-120" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(300)" />
            <line x1="0" y1="-120" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(330)" />
            <line x1="0" y1="-125" x2="0" y2="-140" stroke="black" stroke-width="1" transform="rotate(360)" />
        </g>

    </svg>
    <!-- 数字时间显示 -->
    <div id="timeDisplay"></div>
    <div id="timeInput">
        <input type="number" id="hourInput" min="0" max="23" placeholder="HH">
        <input type="number" id="minuteInput" min="0" max="59" placeholder="MM">
        <input type="number" id="secondInput" min="0" max="59" placeholder="SS">
        <button id="setTimeButton">设置时间</button>
        <button id="getCurrentTimeButton">恢复当前时间</button>
    </div>
    <!-- 日期显示 -->
    <div id="dateDisplay"></div>
    <div id="dateInput">
        <input type="number" id="yearInput" min="1900" max="2100" placeholder="YYYY">
        <input type="number" id="monthInput" min="1" max="12" placeholder="MM">
        <input type="number" id="dayInput" min="1" max="31" placeholder="DD">
        <button id="setDateButton">设置日期</button>
    </div>
    <!-- 错误信息显示 -->
    <div id="errorMessage" style="color: red; margin-top: 10px;"></div>



    <script>
        var clockInterval;
        var userSetHours = 0;
        var userSetMinutes = 0;
        var userSetSeconds = 0;
        var isPM = false;
        var userSetYear, userSetMonth, userSetDay;

        // 更新时钟函数，以输入的时分秒为参数进行设置，若没有输入则默认获取系统时间
        function updateClock(hours, minutes, seconds) {
            userSetHours = hours;
            userSetMinutes = minutes;
            userSetSeconds = seconds;

            var hourHand = document.getElementById('hour-hand');
            var minuteHand = document.getElementById('minute-hand');
            var secondHand = document.getElementById('second-hand');
            var clockFace = document.getElementById('clock-face'); // 获取表盘元素

            // 计算时分秒对应指针的角度
            var hourDeg = (360 / 12) * (userSetHours % 12) + (360 / 12) * (userSetMinutes / 60);
            var minuteDeg = (360 / 60) * userSetMinutes;
            var secondDeg = (360 / 60) * userSetSeconds;

            hourHand.setAttribute('transform', `rotate(${hourDeg}, 150, 150)`);
            minuteHand.setAttribute('transform', `rotate(${minuteDeg}, 150, 150)`);
            secondHand.setAttribute('transform', `rotate(${secondDeg}, 150, 150)`);

            var timeDisplay = document.getElementById('timeDisplay');

            timeDisplay.textContent = `${userSetHours.toString().padStart(2, '0')}:${userSetMinutes.toString().padStart(2, '0')}:${Math.floor(userSetSeconds).toString().padStart(2, '0')}`;

            // 根据时间设置表盘背景颜色
            if (userSetHours >= 6 && userSetHours < 18) {
                clockFace.setAttribute('fill', 'mintcream'); // 奶白色
            } else {
                clockFace.setAttribute('fill', 'lightgray'); // 浅灰色
            }
        }

        // 在有初始时间的基础上不断更新时间，为保证平滑更新周期为0.01s
        function startClock() {
            clearInterval(clockInterval);
            clockInterval = setInterval(function() {
                userSetSeconds += 0.01;
                if (userSetSeconds > 59.999) {
                    userSetSeconds = 0;
                    userSetMinutes++;
                    if (userSetMinutes >= 60) {
                        userSetMinutes = 0;
                        userSetHours++;
                        if (userSetHours >= 24) {
                            userSetHours = 0;
                        }
                    }
                }
                updateClock(userSetHours, userSetMinutes, userSetSeconds);
            }, 10);
        }

        // 初始化时钟，获取系统时间并显示
        (function() {
            var time = new Date();
            var hours = time.getHours();
            var minutes = time.getMinutes();
            var seconds = time.getSeconds();
            isPM = hours >= 12;
            updateClock(hours, minutes, seconds);
            startClock();
        })();

        //根据输入的时分秒设置时间
        document.getElementById('setTimeButton').addEventListener('click', function() {
            var hourInput = document.getElementById('hourInput');
            var minuteInput = document.getElementById('minuteInput');
            var secondInput = document.getElementById('secondInput');

            var hours = parseInt(hourInput.value) || 0;
            var minutes = parseInt(minuteInput.value) || 0;
            var seconds = parseInt(secondInput.value) || 0;

            var errorMessage = document.getElementById('errorMessage');

            // 检查输入时间是否合法
            if (hours < 0 || hours >= 24 || minutes < 0 || minutes >= 60 || seconds < 0 || seconds >= 60) {
                // alert('请输入正确的时间');
                errorMessage.textContent = '请输入正确的时间';
                return;
            }

            // 清除错误消息
            errorMessage.textContent = '';

            isPM = hours >= 12;
            updateClock(hours, minutes, seconds);
            startClock();
        });

        document.getElementById('getCurrentTimeButton').addEventListener('click', function() {
            var time = new Date();
            var hours = time.getHours();
            var minutes = time.getMinutes();
            var seconds = time.getSeconds();
            var year = time.getFullYear();
            var month = time.getMonth() + 1;
            var day = time.getDate();

            isPM = hours >= 12;
            updateClockAndDate(hours, minutes, seconds, year, month, day);
            startClock();
        });

        // 更新时间和日期函数（重置当前时间同时需要重置日期）
        function updateClockAndDate(hours, minutes, seconds, year, month, day) {
            updateClock(hours, minutes, seconds);

            userSetYear = year;
            userSetMonth = month;
            userSetDay = day;

            var dateDisplay = document.getElementById('dateDisplay');
            var formattedDate = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            dateDisplay.textContent = formattedDate;
        }

        // 初始化时钟和日期
        (function() {
            var time = new Date();
            var hours = time.getHours();
            var minutes = time.getMinutes();
            var seconds = time.getSeconds();
            var year = time.getFullYear();
            var month = time.getMonth() + 1;
            var day = time.getDate();
            isPM = hours >= 12;
            updateClockAndDate(hours, minutes, seconds, year, month, day);
            startClock();
        })();

        // 根据输入的日期设置日期
        document.getElementById('setDateButton').addEventListener('click', function() {
            var yearInput = document.getElementById('yearInput');
            var monthInput = document.getElementById('monthInput');
            var dayInput = document.getElementById('dayInput');

            var year = parseInt(yearInput.value) || new Date().getFullYear();
            var month = parseInt(monthInput.value) || 1;
            var day = parseInt(dayInput.value) || 1;

            // 检查输入的日期是否合法
            function isValidDate(year, month, day) {
                // 检查年份范围
                if (year < 1900 || year > 2100) {
                    return false;
                }
                // 检查月份范围
                if (month < 1 || month > 12) {
                    return false;
                }
                // 检查每个月的天数
                var daysInMonth = [31, (isLeapYear(year) ? 29 : 28), 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];
                if (day < 1 || day > daysInMonth[month - 1]) {
                    return false;
                }
                return true;
            }

            // 判断是否是闰年
            function isLeapYear(year) {
                return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
            }

            var errorMessage = document.getElementById('errorMessage');

            // 检查输入日期是否合法
            if (!isValidDate(year, month, day)) {
                errorMessage.textContent = '请输入正确的日期';
                return;
            }

            // 清除错误消息
            errorMessage.textContent = '';
            
            updateClockAndDate(userSetHours, userSetMinutes, userSetSeconds, year, month, day);
            startClock();
        });

        document.getElementById('hour-hand').addEventListener('mousedown', handleMouseDown);
        document.getElementById('minute-hand').addEventListener('mousedown', handleMouseDown);
        document.getElementById('second-hand').addEventListener('mousedown', handleMouseDown);

        function handleMouseDown(event) {
            var element = event.target;
            var clock = document.getElementById('clock');
            var rect = clock.getBoundingClientRect();
            var startAngle = getAngle(event.clientX - rect.left, event.clientY - rect.top);
            var crossedZeroClockwise = false;
            var crossedZeroCounterClockwise = false;

            function moveHandler(event) {
                var currentAngle = getAngle(event.clientX - rect.left, event.clientY - rect.top);
                var deltaAngle = currentAngle - startAngle;
                if (deltaAngle < -180) deltaAngle += 360;
                if (deltaAngle > 180) deltaAngle -= 360;

                if (element.id === 'hour-hand') {
                    if (startAngle > 270 && currentAngle < 90) {
                        crossedZeroClockwise = true;
                    } else if (startAngle < 90 && currentAngle > 270) {
                        crossedZeroCounterClockwise = true;
                    }
                    if (crossedZeroCounterClockwise && currentAngle > 180) {
                        // 日期-1
                        changeDate(-1);
                        isPM = !isPM;
                        crossedZeroCounterClockwise = false;
                    } else if (crossedZeroClockwise && currentAngle < 180) {
                        // 日期+1
                        changeDate(1);
                        isPM = !isPM;
                        crossedZeroClockwise = false;
                    }
                }
                if (element.id === 'minute-hand') {
                    if (startAngle > 270 && currentAngle < 90) {
                        crossedZeroClockwise = true;
                    } else if (startAngle < 90 && currentAngle > 270) {
                        crossedZeroCounterClockwise = true;
                    }
                    if (crossedZeroCounterClockwise && currentAngle > 180) {
                        userSetHours = (userSetHours + 23) % 24;
                        crossedZeroCounterClockwise = false;
                    } else if (crossedZeroClockwise && currentAngle < 180) {
                        userSetHours = (userSetHours + 1) % 24;
                        crossedZeroClockwise = false;
                    }
                }
                if (element.id === 'second-hand') {
                    if (startAngle > 270 && currentAngle < 90) {
                        crossedZeroClockwise = true;
                    } else if (startAngle < 90 && currentAngle > 270) {
                        crossedZeroCounterClockwise = true;
                    }
                    if (crossedZeroCounterClockwise && currentAngle > 180) {
                        userSetMinutes = (userSetMinutes + 59) % 60;
                        crossedZeroCounterClockwise = false;
                    } else if (crossedZeroClockwise && currentAngle < 180) {
                        userSetMinutes = (userSetMinutes + 1) % 60;
                        crossedZeroClockwise = false;
                    }
                }

                // 直接更新指针角度
                updateHandAngle(element, currentAngle);

                // 更新起始角度
                startAngle = currentAngle;
            }

            function upHandler() {
                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('mouseup', upHandler);
            }

            document.addEventListener('mousemove', moveHandler);
            document.addEventListener('mouseup', upHandler);
        }

        // 改变日期函数
        function changeDate(deltaDays) {
            var date = new Date(userSetYear, userSetMonth - 1, userSetDay + deltaDays);
            userSetYear = date.getFullYear();
            userSetMonth = date.getMonth() + 1;
            userSetDay = date.getDate();
            updateClockAndDate(userSetHours, userSetMinutes, userSetSeconds, userSetYear, userSetMonth, userSetDay);
        }

        function updateHandAngle(element, angle) {
            var transformOrigin = "rotate(" + angle + " 150 150)";
            element.setAttribute("transform", transformOrigin);

            // 计算并更新时间
            var hours = userSetHours;
            var minutes = userSetMinutes;
            var seconds = userSetSeconds;

            if (element.id === 'hour-hand') {
                hours = Math.floor(angle / 30);
                if (isPM) {
                    userSetHours = (hours + 12) % 24;
                } else {
                    userSetHours = hours % 12;
                }
            } else if (element.id === 'minute-hand') {
                minutes = Math.floor(angle / 6);
                userSetMinutes = (minutes + 60) % 60;
            } else if (element.id === 'second-hand') {
                seconds = Math.floor(angle / 6);
                userSetSeconds = (seconds + 60) % 60;
            }

            // 更新时间显示
            var timeDisplay = document.getElementById('timeDisplay');
            var formattedTime = `${userSetHours.toString().padStart(2, '0')}:${userSetMinutes.toString().padStart(2, '0')}:${Math.floor(userSetSeconds).toString().padStart(2, '0')}`;
            timeDisplay.textContent = formattedTime;
        }

        function getAngle(x, y) {
            var centerX = 150;
            var centerY = 150;
            var angle = Math.atan2(y - centerY, x - centerX) * (180 / Math.PI);
            return (angle + 90 + 360) % 360; // 90度偏移是debug出来的，推断是坐标原点对应坐标计算方式导致
        }

        function updateHandTime(element, startTime, deltaAngle) {
            var hours = startTime.hours;
            var minutes = startTime.minutes;
            var seconds = startTime.seconds;

            if (element.id === 'hour-hand') {
                var deltaHours = deltaAngle / 30;
                hours = (startTime.hours + deltaHours) % 24;
                if (hours < 0) hours += 24;
            } else if (element.id === 'minute-hand') {
                var deltaMinutes = deltaAngle / 6;
                minutes = (startTime.minutes + deltaMinutes) % 60;
                if (minutes < 0) minutes += 60;
            } else if (element.id === 'second-hand') {
                var deltaSeconds = deltaAngle / 6;
                seconds = (startTime.seconds + deltaSeconds) % 60;
                if (seconds < 0) seconds += 60;
            }

            hours = Math.floor(hours);
            minutes = Math.floor(minutes);
            seconds = Math.floor(seconds);

            updateClock(hours, minutes, seconds);
        }

        // 表盘提供一个接口，用于获取当前时间
        // 通过postMessage进行页面间通信,获取时间方式参考htmls/alarm/alarm.html
        window.addEventListener('message', (event) => {
            if (event.data.type === 'getTime') {
                // 发送时间结构体t回父页面
                if (event.source) {
                    event.source.postMessage({
                        type: 't',
                        hours: userSetHours,
                        minutes: userSetMinutes,
                        seconds: userSetSeconds
                    }, '*');
                }else{
                    console.error('ERROR: no source event');
                }
            }
        }, false);
    </script>
</body>
</html>
